<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ü–µ–Ω—ã –∑–∞ –µ–¥–∏–Ω–∏—Ü—É —Ç–æ–≤–∞—Ä–∞ —Å —Ñ—É–Ω–∫—Ü–∏–µ–π —Å—Ä–∞–≤–Ω–µ–Ω–∏—è">
    <title>–¶–µ–Ω–∞–ó–∞1 ‚Äî –°—Ä–∞–≤–Ω–∏ –∏ —Å—ç–∫–æ–Ω–æ–º—å</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;500;600;700&family=Manrope:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: rgba(255, 255, 255, 0.03);
            --bg-card-hover: rgba(255, 255, 255, 0.06);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.6);
            --text-muted: rgba(255, 255, 255, 0.35);
            --accent-primary: #10b981;
            --accent-secondary: #059669;
            --accent-glow: rgba(16, 185, 129, 0.15);
            --danger: #f87171;
            --danger-glow: rgba(248, 113, 113, 0.15);
            --best-deal: #f59e0b;
            --best-deal-glow: rgba(245, 158, 11, 0.2);
            --border: rgba(255, 255, 255, 0.08);
            --border-focus: rgba(16, 185, 129, 0.5);
            --gradient-start: rgba(16, 185, 129, 0.08);
            --gradient-mid: rgba(5, 150, 105, 0.05);
            --gradient-end: rgba(245, 158, 11, 0.04);
            --radius-sm: 12px;
            --radius-md: 16px;
            --radius-lg: 24px;
            --radius-xl: 32px;
            --shadow-glow: 0 0 60px rgba(16, 185, 129, 0.1);
            --font-display: 'Unbounded', sans-serif;
            --font-body: 'Manrope', sans-serif;
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        /* Light Theme */
        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-card: rgba(255, 255, 255, 0.8);
            --bg-card-hover: rgba(255, 255, 255, 0.95);
            --text-primary: #0f172a;
            --text-secondary: rgba(15, 23, 42, 0.65);
            --text-muted: rgba(15, 23, 42, 0.4);
            --accent-primary: #059669;
            --accent-secondary: #047857;
            --accent-glow: rgba(5, 150, 105, 0.12);
            --danger: #dc2626;
            --danger-glow: rgba(220, 38, 38, 0.1);
            --best-deal: #d97706;
            --best-deal-glow: rgba(217, 119, 6, 0.15);
            --border: rgba(15, 23, 42, 0.08);
            --border-focus: rgba(5, 150, 105, 0.4);
            --gradient-start: rgba(5, 150, 105, 0.06);
            --gradient-mid: rgba(4, 120, 87, 0.04);
            --gradient-end: rgba(217, 119, 6, 0.03);
            --shadow-glow: 0 0 60px rgba(5, 150, 105, 0.08);
        }

        [data-theme="light"] .bg-gradient {
            background:
                    radial-gradient(ellipse 80% 50% at 50% -20%, var(--gradient-start), transparent),
                    radial-gradient(ellipse 60% 40% at 100% 50%, var(--gradient-mid), transparent),
                    radial-gradient(ellipse 50% 30% at 0% 80%, var(--gradient-end), transparent);
        }

        [data-theme="light"] .calc-card,
        [data-theme="light"] .product-card {
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
        }

        [data-theme="light"] .input-field {
            background: var(--bg-primary);
        }

        [data-theme="light"] .price-box {
            background: var(--bg-primary);
        }

        html, body {
            font-family: var(--font-body);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
        }

        body {
            padding-bottom: calc(100px + var(--safe-bottom));
        }

        /* Animated background */
        .bg-gradient {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                    radial-gradient(ellipse 80% 50% at 50% -20%, rgba(110, 231, 183, 0.08), transparent),
                    radial-gradient(ellipse 60% 40% at 100% 50%, rgba(52, 211, 153, 0.05), transparent),
                    radial-gradient(ellipse 50% 30% at 0% 80%, rgba(251, 191, 36, 0.04), transparent);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 480px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        header {
            padding: 24px 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            text-align: left;
        }

        .logo {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--best-deal));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
        }

        .tagline {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 4px;
            letter-spacing: 0.02em;
        }

        /* Theme Switcher */
        .theme-switcher {
            display: flex;
            align-items: center;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 4px;
            gap: 2px;
        }

        .theme-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.2s ease;
        }

        [data-theme="light"] .theme-btn {
            color: rgba(15, 23, 42, 0.5);
        }

        .theme-btn:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }

        .theme-btn.active {
            background: var(--accent-glow);
            color: var(--accent-primary);
        }

        .theme-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Calculator Card */
        .calc-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            padding: 24px;
            margin-bottom: 24px;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .calc-title {
            font-family: var(--font-display);
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .calc-title-icon {
            width: 32px;
            height: 32px;
            background: var(--accent-glow);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Input Groups */
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .input-group {
            position: relative;
        }

        .input-group.full {
            grid-column: 1 / -1;
            margin-bottom: 16px;
        }

        .input-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .input-field {
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 14px 16px;
            font-family: var(--font-body);
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-primary);
            transition: all 0.2s ease;
            -webkit-appearance: none;
            appearance: none;
        }

        .input-field::placeholder {
            color: var(--text-muted);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 4px var(--accent-glow);
        }

        .input-field::-webkit-outer-spin-button,
        .input-field::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .input-field[type="number"] {
            -moz-appearance: textfield;
        }

        /* Unit Selector */
        .unit-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        .unit-btn {
            flex: 1;
            padding: 12px 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-family: var(--font-body);
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .unit-btn.active {
            background: var(--accent-glow);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .unit-btn:active {
            transform: scale(0.96);
        }

        /* Add Button */
        .add-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            border-radius: var(--radius-md);
            font-family: var(--font-display);
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--bg-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .add-btn:hover {
            box-shadow: var(--shadow-glow);
        }

        .add-btn:active {
            transform: scale(0.98);
        }

        .add-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Results Section */
        .results-section {
            margin-bottom: 24px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .section-title {
            font-family: var(--font-display);
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .item-count {
            background: var(--bg-card);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .clear-all {
            background: none;
            border: none;
            font-family: var(--font-body);
            font-size: 0.8rem;
            color: var(--danger);
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-sm);
            transition: background 0.2s;
        }

        .clear-all:active {
            background: var(--danger-glow);
        }

        /* Product Cards */
        .products-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .product-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 16px;
            animation: cardIn 0.3s ease-out;
            position: relative;
            overflow: hidden;
            touch-action: pan-y pinch-zoom;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }

        .product-card.swiping {
            transition: none;
        }

        .product-card.removing {
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
        }

        .product-card.removing.swipe-left {
            transform: translateX(-100%);
        }

        .product-card.removing.swipe-right {
            transform: translateX(100%);
        }

        .swipe-hint {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }

        .swipe-hint-left {
            left: 0;
            background: linear-gradient(90deg, var(--danger-glow), transparent);
        }

        .swipe-hint-right {
            right: 0;
            background: linear-gradient(-90deg, var(--danger-glow), transparent);
        }

        .swipe-hint svg {
            width: 24px;
            height: 24px;
            stroke: var(--danger);
        }

        .product-card.swiping .swipe-hint {
            opacity: 1;
        }

        @keyframes cardIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .product-card.best-deal {
            border-color: var(--best-deal);
            box-shadow: 0 0 30px var(--best-deal-glow);
        }

        .product-card.best-deal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--best-deal), var(--accent-primary));
        }

        .best-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--best-deal);
            color: var(--bg-primary);
            font-family: var(--font-display);
            font-size: 0.65rem;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .product-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .product-name {
            font-family: var(--font-display);
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            max-width: 200px;
            word-break: break-word;
        }

        .product-original {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 6px;
            padding: 6px 10px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            display: inline-block;
        }

        .product-original strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .delete-btn {
            background: var(--danger-glow);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .delete-btn:active {
            transform: scale(0.9);
            background: rgba(248, 113, 113, 0.3);
        }

        .delete-btn svg {
            width: 16px;
            height: 16px;
            stroke: var(--danger);
        }

        .price-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .price-box {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 12px;
        }

        .price-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 4px;
        }

        .price-value {
            font-family: var(--font-display);
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .price-value small {
            font-size: 0.7rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-muted);
        }

        .empty-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            opacity: 0.3;
        }

        .empty-title {
            font-family: var(--font-display);
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .empty-text {
            font-size: 0.85rem;
            line-height: 1.5;
        }

        /* Sort Toggle */
        .sort-toggle {
            display: flex;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 4px;
            margin-bottom: 16px;
        }

        .sort-btn {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            border-radius: var(--radius-sm);
            font-family: var(--font-body);
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .sort-btn.active {
            background: var(--accent-glow);
            color: var(--accent-primary);
        }

        /* Install Banner */
        .install-banner {
            position: fixed;
            bottom: calc(20px + var(--safe-bottom));
            left: 20px;
            right: 20px;
            max-width: 440px;
            margin: 0 auto;
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 16px;
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 100;
            animation: slideUp 0.5s ease-out;
        }

        .install-banner.show {
            display: flex;
        }

        .install-text {
            flex: 1;
        }

        .install-title {
            font-family: var(--font-display);
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .install-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .install-btn {
            background: var(--accent-primary);
            border: none;
            padding: 10px 16px;
            border-radius: var(--radius-sm);
            font-family: var(--font-display);
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--bg-primary);
            cursor: pointer;
            white-space: nowrap;
        }

        .install-close {
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
            color: var(--text-muted);
        }

        /* Responsive */
        @media (max-width: 360px) {
            .container {
                padding: 0 16px;
            }

            .calc-card {
                padding: 20px;
            }

            .unit-btn {
                font-size: 0.75rem;
                padding: 10px 4px;
            }

            .price-value {
                font-size: 1rem;
            }
        }

        /* Safe area for notched devices */
        @supports (padding-top: env(safe-area-inset-top)) {
            header {
                padding-top: calc(24px + env(safe-area-inset-top));
            }
        }

        /* History Section */
        .history-section {
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .history-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .history-title {
            font-family: var(--font-display);
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .save-session-btn {
            padding: 10px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-family: var(--font-body);
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--accent-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .save-session-btn:hover {
            background: var(--accent-glow);
            border-color: var(--accent-primary);
        }

        .save-session-btn:active {
            transform: scale(0.97);
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .history-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .history-card:hover {
            border-color: var(--accent-primary);
            background: var(--bg-card-hover);
        }

        .history-card:active {
            transform: scale(0.98);
        }

        .history-card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .history-card-name {
            font-family: var(--font-display);
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .history-card-date {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .history-card-info {
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .history-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .history-action-btn {
            flex: 1;
            padding: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-family: var(--font-body);
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-action-btn:hover {
            color: var(--text-primary);
            border-color: var(--text-secondary);
        }

        .history-action-btn.danger:hover {
            color: var(--danger);
            border-color: var(--danger);
            background: var(--danger-glow);
        }

        .history-empty {
            text-align: center;
            padding: 24px;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* Save Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 20px;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            padding: 24px;
            width: 100%;
            max-width: 360px;
            animation: modalIn 0.3s ease-out;
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-title {
            font-family: var(--font-display);
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .modal-input {
            width: 100%;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 14px 16px;
            font-family: var(--font-body);
            font-size: 1rem;
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .modal-input:focus {
            outline: none;
            border-color: var(--border-focus);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 14px;
            border-radius: var(--radius-md);
            font-family: var(--font-display);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn.cancel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .modal-btn.confirm {
            background: var(--accent-primary);
            border: none;
            color: var(--bg-primary);
        }

        .modal-btn:active {
            transform: scale(0.97);
        }
    </style>
</head>
<body>
<div class="bg-gradient"></div>

<div class="container">
    <header>
        <div class="header-left">
            <div class="logo">–¶–µ–Ω–∞–ó–∞1</div>
            <div class="tagline">–°—Ä–∞–≤–Ω–∏ —Ü–µ–Ω—ã ‚Äî –≤—ã–±–µ—Ä–∏ –ª—É—á—à–µ–µ</div>
        </div>
        <div class="theme-switcher">
            <button class="theme-btn" data-theme="light" title="–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
            </button>
            <button class="theme-btn" data-theme="dark" title="–¢—ë–º–Ω–∞—è —Ç–µ–º–∞">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
            </button>
        </div>
    </header>

    <div class="calc-card">
        <div class="calc-title">
            <div class="calc-title-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--accent-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="1" x2="12" y2="23"></line>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                </svg>
            </div>
            –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
        </div>

        <div class="input-group full">
            <label class="input-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</label>
            <input type="text" class="input-field" id="productName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ–ª–æ–∫–æ –ü—Ä–æ—Å—Ç–æ–∫–≤–∞—à–∏–Ω–æ">
        </div>

        <div class="input-row">
            <div class="input-group">
                <label class="input-label">–¶–µ–Ω–∞ (‚ÇΩ)</label>
                <input type="number" class="input-field" id="price" placeholder="150" inputmode="decimal">
            </div>
            <div class="input-group">
                <label class="input-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                <input type="number" class="input-field" id="quantity" placeholder="100" inputmode="decimal">
            </div>
        </div>

        <label class="input-label">–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è</label>
        <div class="unit-selector">
            <button class="unit-btn active" data-unit="g" data-large="kg" data-factor="1000">–≥—Ä–∞–º–º—ã</button>
            <button class="unit-btn" data-unit="ml" data-large="l" data-factor="1000">–º–ª</button>
            <button class="unit-btn" data-unit="—à—Ç" data-large="10—à—Ç" data-factor="10">—à—Ç—É–∫–∏</button>
        </div>

        <button class="add-btn" id="addProduct">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            –î–æ–±–∞–≤–∏—Ç—å –∫ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é
        </button>
    </div>

    <div class="results-section" id="resultsSection" style="display: none;">
        <div class="section-header">
            <div class="section-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="20" x2="18" y2="10"></line>
                    <line x1="12" y1="20" x2="12" y2="4"></line>
                    <line x1="6" y1="20" x2="6" y2="14"></line>
                </svg>
                –°—Ä–∞–≤–Ω–µ–Ω–∏–µ
                <span class="item-count" id="itemCount">0</span>
            </div>
            <button class="clear-all" id="clearAll">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
        </div>

        <div class="sort-toggle">
            <button class="sort-btn active" data-sort="price">–ü–æ —Ü–µ–Ω–µ ‚Üë</button>
            <button class="sort-btn" data-sort="added">–ù–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É</button>
        </div>

        <div class="products-list" id="productsList"></div>
    </div>

    <div class="empty-state" id="emptyState">
        <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="9" cy="21" r="1"></circle>
            <circle cx="20" cy="21" r="1"></circle>
            <path d="m1 1 4 4 2.68 11.63a2 2 0 0 0 2 1.37h9.72a2 2 0 0 0 2-1.63L23 6H6"></path>
        </svg>
        <div class="empty-title">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>
        <div class="empty-text">–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è,<br>—á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –ª—É—á—à—É—é —Ü–µ–Ω—É</div>
    </div>

    <!-- History Section -->
    <div class="history-section" id="historySection">
        <div class="history-header">
            <div class="history-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                –ò—Å—Ç–æ—Ä–∏—è —Å—Ä–∞–≤–Ω–µ–Ω–∏–π
            </div>
            <button class="save-session-btn" id="saveSessionBtn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                    <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
        </div>
        <div class="history-list" id="historyList">
            <div class="history-empty">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Å—Ä–∞–≤–Ω–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</div>
        </div>
    </div>
</div>

<!-- Save Modal -->
<div class="modal-overlay" id="saveModal">
    <div class="modal">
        <div class="modal-title">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ</div>
        <input type="text" class="modal-input" id="sessionNameInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä: –ú–æ–ª–æ–∫–æ –≤ –ü—è—Ç—ë—Ä–æ—á–∫–µ">
        <div class="modal-buttons">
            <button class="modal-btn cancel" id="modalCancel">–û—Ç–º–µ–Ω–∞</button>
            <button class="modal-btn confirm" id="modalConfirm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<div class="install-banner" id="installBanner">
    <div class="install-text">
        <div class="install-title">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</div>
        <div class="install-desc">–î–æ–±–∞–≤—å—Ç–µ –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω</div>
    </div>
    <button class="install-btn" id="installBtn">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
    <button class="install-close" id="installClose">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
    </button>
</div>

<script>
    // Theme Management
    const themeBtns = document.querySelectorAll('.theme-btn');
    const html = document.documentElement;

    function getSystemTheme() {
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }

    function applyTheme(theme) {
        html.setAttribute('data-theme', theme);

        // Update meta theme-color
        const metaTheme = document.querySelector('meta[name="theme-color"]');
        metaTheme.content = theme === 'dark' ? '#0a0a0f' : '#f8fafc';
    }

    function setTheme(theme) {
        localStorage.setItem('theme', theme);
        applyTheme(theme);

        themeBtns.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.theme === theme);
        });
    }

    // Initialize theme: use saved or detect from system
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
        setTheme(savedTheme);
    } else {
        setTheme(getSystemTheme());
    }

    // Theme button clicks
    themeBtns.forEach(btn => {
        btn.addEventListener('click', () => setTheme(btn.dataset.theme));
    });

    // App State
    let products = JSON.parse(localStorage.getItem('products') || '[]');
    let currentUnit = { unit: 'g', large: 'kg', factor: 1000 };
    let sortBy = 'price';
    let deferredPrompt = null;

    // DOM Elements
    const productNameInput = document.getElementById('productName');
    const priceInput = document.getElementById('price');
    const quantityInput = document.getElementById('quantity');
    const addBtn = document.getElementById('addProduct');
    const productsList = document.getElementById('productsList');
    const resultsSection = document.getElementById('resultsSection');
    const emptyState = document.getElementById('emptyState');
    const itemCount = document.getElementById('itemCount');
    const clearAllBtn = document.getElementById('clearAll');
    const unitBtns = document.querySelectorAll('.unit-btn');
    const sortBtns = document.querySelectorAll('.sort-btn');
    const installBanner = document.getElementById('installBanner');
    const installBtn = document.getElementById('installBtn');
    const installClose = document.getElementById('installClose');

    // Unit Selection
    unitBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            unitBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentUnit = {
                unit: btn.dataset.unit,
                large: btn.dataset.large,
                factor: parseInt(btn.dataset.factor)
            };
        });
    });

    // Sort Selection
    sortBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            sortBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            sortBy = btn.dataset.sort;
            renderProducts();
        });
    });

    // Add Product
    addBtn.addEventListener('click', addProduct);

    // Enter key support
    [productNameInput, priceInput, quantityInput].forEach(input => {
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addProduct();
        });
    });

    function addProduct() {
        const name = productNameInput.value.trim() || `–¢–æ–≤–∞—Ä ${products.length + 1}`;
        const price = parseFloat(priceInput.value);
        const quantity = parseFloat(quantityInput.value);

        if (!price || !quantity || price <= 0 || quantity <= 0) {
            // Shake animation for invalid input
            addBtn.style.animation = 'none';
            addBtn.offsetHeight; // Trigger reflow
            addBtn.style.animation = 'shake 0.4s ease';
            return;
        }

        const pricePerUnit = price / quantity;
        const pricePerLarge = pricePerUnit * currentUnit.factor;

        const product = {
            id: Date.now(),
            name,
            originalPrice: price,
            originalQuantity: quantity,
            unit: currentUnit.unit,
            largeUnit: currentUnit.large,
            factor: currentUnit.factor,
            pricePerUnit,
            pricePerLarge,
            addedAt: Date.now()
        };

        products.push(product);
        saveProducts();
        renderProducts();

        // Clear inputs
        productNameInput.value = '';
        priceInput.value = '';
        quantityInput.value = '';
        productNameInput.focus();

        // Haptic feedback if available
        if (navigator.vibrate) {
            navigator.vibrate(10);
        }
    }

    function deleteProduct(id) {
        products = products.filter(p => p.id !== id);
        saveProducts();
        renderProducts();

        if (navigator.vibrate) {
            navigator.vibrate([10, 50, 10]);
        }
    }

    function clearAll() {
        if (products.length === 0) return;

        if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã?')) {
            products = [];
            saveProducts();
            renderProducts();
        }
    }

    clearAllBtn.addEventListener('click', clearAll);

    function saveProducts() {
        localStorage.setItem('products', JSON.stringify(products));
    }

    function formatPrice(price) {
        if (price >= 1000) {
            return price.toLocaleString('ru-RU', { maximumFractionDigits: 0 });
        } else if (price >= 100) {
            return price.toLocaleString('ru-RU', { maximumFractionDigits: 1 });
        } else if (price >= 1) {
            return price.toLocaleString('ru-RU', { maximumFractionDigits: 2 });
        } else {
            return price.toLocaleString('ru-RU', { maximumFractionDigits: 3 });
        }
    }

    function renderProducts() {
        if (products.length === 0) {
            resultsSection.style.display = 'none';
            emptyState.style.display = 'block';
            return;
        }

        resultsSection.style.display = 'block';
        emptyState.style.display = 'none';
        itemCount.textContent = products.length;

        // Sort products
        let sorted = [...products];
        if (sortBy === 'price') {
            sorted.sort((a, b) => a.pricePerUnit - b.pricePerUnit);
        } else {
            // –ü–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—é - –Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É
            sorted.sort((a, b) => b.addedAt - a.addedAt);
        }

        // Find best deal
        const bestDealId = sorted.reduce((best, current) =>
                current.pricePerUnit < (best?.pricePerUnit ?? Infinity) ? current : best
            , null)?.id;

        productsList.innerHTML = sorted.map(product => `
                <div class="product-card ${product.id === bestDealId && products.length > 1 ? 'best-deal' : ''}" data-id="${product.id}">
                    <div class="swipe-hint swipe-hint-left">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </div>
                    <div class="swipe-hint swipe-hint-right">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </div>
                    ${product.id === bestDealId && products.length > 1 ? '<div class="best-badge">üèÜ –õ—É—á—à–∞—è —Ü–µ–Ω–∞</div>' : ''}
                    <div class="product-header">
                        <div>
                            <div class="product-name">${escapeHtml(product.name)}</div>
                            <div class="product-original"><strong>${formatPrice(product.originalPrice)} ‚ÇΩ</strong> –∑–∞ <strong>${formatPrice(product.originalQuantity)} ${product.unit}</strong></div>
                        </div>
                        <button class="delete-btn" onclick="deleteProduct(${product.id})">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="price-grid">
                        <div class="price-box">
                            <div class="price-label">–ó–∞ 1 ${product.unit}</div>
                            <div class="price-value">${formatPrice(product.pricePerUnit)} <small>‚ÇΩ</small></div>
                        </div>
                        <div class="price-box">
                            <div class="price-label">–ó–∞ 1 ${product.largeUnit}</div>
                            <div class="price-value">${formatPrice(product.pricePerLarge)} <small>‚ÇΩ</small></div>
                        </div>
                    </div>
                </div>
            `).join('');

        // Initialize swipe handlers
        initSwipeHandlers();
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Swipe to delete functionality
    function initSwipeHandlers() {
        const cards = document.querySelectorAll('.product-card');

        cards.forEach(card => {
            let startX = 0;
            let currentX = 0;
            let isDragging = false;
            const threshold = 80; // Minimum swipe distance to trigger delete

            card.addEventListener('touchstart', (e) => {
                // Don't start swipe if touching delete button
                if (e.target.closest('.delete-btn')) return;

                startX = e.touches[0].clientX;
                isDragging = true;
                card.classList.add('swiping');
            }, { passive: true });

            card.addEventListener('touchmove', (e) => {
                if (!isDragging) return;

                currentX = e.touches[0].clientX - startX;

                // Apply resistance at edges
                const resistance = 0.4;
                const translateX = currentX * resistance;

                card.style.transform = `translateX(${translateX}px)`;
            }, { passive: true });

            card.addEventListener('touchend', () => {
                if (!isDragging) return;
                isDragging = false;
                card.classList.remove('swiping');

                const translateX = currentX * 0.4;

                if (Math.abs(translateX) > threshold) {
                    // Trigger delete
                    const direction = translateX < 0 ? 'swipe-left' : 'swipe-right';
                    card.classList.add('removing', direction);

                    const productId = parseInt(card.dataset.id);

                    setTimeout(() => {
                        deleteProduct(productId);
                    }, 300);
                } else {
                    // Snap back
                    card.style.transform = '';
                }

                currentX = 0;
            });

            // Mouse support for desktop testing
            card.addEventListener('mousedown', (e) => {
                if (e.target.closest('.delete-btn')) return;

                startX = e.clientX;
                isDragging = true;
                card.classList.add('swiping');

                const onMouseMove = (e) => {
                    if (!isDragging) return;
                    currentX = e.clientX - startX;
                    const resistance = 0.4;
                    card.style.transform = `translateX(${currentX * resistance}px)`;
                };

                const onMouseUp = () => {
                    if (!isDragging) return;
                    isDragging = false;
                    card.classList.remove('swiping');

                    const translateX = currentX * 0.4;

                    if (Math.abs(translateX) > threshold) {
                        const direction = translateX < 0 ? 'swipe-left' : 'swipe-right';
                        card.classList.add('removing', direction);

                        const productId = parseInt(card.dataset.id);
                        setTimeout(() => deleteProduct(productId), 300);
                    } else {
                        card.style.transform = '';
                    }

                    currentX = 0;
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                };

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
        });
    }

    // Shake animation
    const style = document.createElement('style');
    style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                20%, 60% { transform: translateX(-8px); }
                40%, 80% { transform: translateX(8px); }
            }
        `;
    document.head.appendChild(style);

    // PWA Install
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;

        // Show install banner after a delay
        setTimeout(() => {
            if (!localStorage.getItem('installDismissed')) {
                installBanner.classList.add('show');
            }
        }, 3000);
    });

    installBtn.addEventListener('click', async () => {
        if (!deferredPrompt) return;

        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;

        if (outcome === 'accepted') {
            installBanner.classList.remove('show');
        }
        deferredPrompt = null;
    });

    installClose.addEventListener('click', () => {
        installBanner.classList.remove('show');
        localStorage.setItem('installDismissed', 'true');
    });

    // Service Worker Registration
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('SW registered'))
                .catch(err => console.log('SW registration failed:', err));
        });
    }

    // Initial render
    renderProducts();

    // History Management
    let savedSessions = JSON.parse(localStorage.getItem('savedSessions') || '[]');
    const historySection = document.getElementById('historySection');
    const historyList = document.getElementById('historyList');
    const saveSessionBtn = document.getElementById('saveSessionBtn');
    const saveModal = document.getElementById('saveModal');
    const sessionNameInput = document.getElementById('sessionNameInput');
    const modalCancel = document.getElementById('modalCancel');
    const modalConfirm = document.getElementById('modalConfirm');

    function renderHistory() {
        if (savedSessions.length === 0) {
            historyList.innerHTML = '<div class="history-empty">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Å—Ä–∞–≤–Ω–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</div>';
            return;
        }

        historyList.innerHTML = savedSessions.map((session, index) => {
            const date = new Date(session.savedAt);
            const dateStr = date.toLocaleDateString('ru-RU', {
                day: 'numeric',
                month: 'short',
                hour: '2-digit',
                minute: '2-digit'
            });

            const bestPrice = session.products.reduce((best, p) =>
                    p.pricePerUnit < (best?.pricePerUnit ?? Infinity) ? p : best
                , null);

            return `
                    <div class="history-card" data-index="${index}">
                        <div class="history-card-header">
                            <div class="history-card-name">${escapeHtml(session.name)}</div>
                            <div class="history-card-date">${dateStr}</div>
                        </div>
                        <div class="history-card-info">
                            <span>üì¶ ${session.products.length} —Ç–æ–≤–∞—Ä–æ–≤</span>
                            ${bestPrice ? `<span>üèÜ –æ—Ç ${formatPrice(bestPrice.pricePerUnit)} ‚ÇΩ/${bestPrice.unit}</span>` : ''}
                        </div>
                        <div class="history-card-actions">
                            <button class="history-action-btn load-btn" data-index="${index}">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                            <button class="history-action-btn danger delete-history-btn" data-index="${index}">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>
                `;
        }).join('');

        // Add event listeners
        document.querySelectorAll('.load-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                loadSession(parseInt(btn.dataset.index));
            });
        });

        document.querySelectorAll('.delete-history-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteSession(parseInt(btn.dataset.index));
            });
        });
    }

    function loadSession(index) {
        const session = savedSessions[index];
        if (!session) return;

        if (products.length > 0) {
            if (!confirm(`–ó–∞–≥—Ä—É–∑–∏—Ç—å "${session.name}"? –¢–µ–∫—É—â–µ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω–æ.`)) {
                return;
            }
        }

        products = [...session.products];
        // Update IDs to avoid conflicts
        products = products.map((p, i) => ({ ...p, id: Date.now() + i, addedAt: Date.now() + i }));
        saveProducts();
        renderProducts();

        // Scroll to results
        resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

        if (navigator.vibrate) {
            navigator.vibrate(10);
        }
    }

    function deleteSession(index) {
        const session = savedSessions[index];
        if (confirm(`–£–¥–∞–ª–∏—Ç—å "${session.name}"?`)) {
            savedSessions.splice(index, 1);
            localStorage.setItem('savedSessions', JSON.stringify(savedSessions));
            renderHistory();

            if (navigator.vibrate) {
                navigator.vibrate([10, 50, 10]);
            }
        }
    }

    function showSaveModal() {
        if (products.length === 0) {
            alert('–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            return;
        }

        sessionNameInput.value = '';
        saveModal.classList.add('show');
        setTimeout(() => sessionNameInput.focus(), 100);
    }

    function hideSaveModal() {
        saveModal.classList.remove('show');
    }

    function saveSession() {
        const name = sessionNameInput.value.trim() || `–°—Ä–∞–≤–Ω–µ–Ω–∏–µ ${savedSessions.length + 1}`;

        const session = {
            name,
            products: [...products],
            savedAt: Date.now()
        };

        savedSessions.unshift(session);

        // Keep only last 20 sessions
        if (savedSessions.length > 20) {
            savedSessions = savedSessions.slice(0, 20);
        }

        localStorage.setItem('savedSessions', JSON.stringify(savedSessions));
        renderHistory();
        hideSaveModal();

        if (navigator.vibrate) {
            navigator.vibrate(10);
        }
    }

    saveSessionBtn.addEventListener('click', showSaveModal);
    modalCancel.addEventListener('click', hideSaveModal);
    modalConfirm.addEventListener('click', saveSession);

    saveModal.addEventListener('click', (e) => {
        if (e.target === saveModal) hideSaveModal();
    });

    sessionNameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') saveSession();
    });

    // Initial history render
    renderHistory();
</script>
</body>
</html>